//  dMVC framework ------------------------

var _ = require('./lib/underscore');

var View = function (model) {

    this.modelID = model.id;

};

View.prototype = {

    setElement: function(el) {
        this.element = el;
    }

};

var Model = function (data) {

    _.extend(this, data);

};

Model.prototype = {

    save: function(req, res, next) {
        var self = this,
            task = new Controller._dbTask({
            userID: this.userID,
            task: this.task,
            done: this.done
        });
        task.save(function (err, task) {
            if (err) {
                res.json({error: err});
            } else {
                self.id = task._id;
                //TODO: stopped here, create view, send to client (using req, res) ?
            }
        });
    }

};

var Controller = {

    addModel: function(req, res, next/*data*/) {
        var task = new Model({
            userID: req.session.userID,
            task: req.body.task,
            done: false
        });
        task.save(req, res, next);
    }

};

//  dMVC framework end ------------------------


//  app -----------------------------------

var init = function(dbConnection) {

    //Controller._db = dbConnection;  //mongoose

    //TODO: remove db reference into the model via some kind of config
    var tasksSchema = dbConnection.Schema({
        userID: String,
        task: String,
        done: Boolean
    });
    //var Task = mongoose.model('Tasks', tasksSchema);
    Controller._dbTask = mongoose.model('Tasks', tasksSchema);

};

module.exports.init = init;
module.exports.Controller = Controller;